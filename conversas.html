<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Conversas | Cacife Brand</title>

    <!-- Favicons / theme -->
    <link rel="icon" href="favicon.png" type="image/png" sizes="32x32">
    <meta name="theme-color" content="#ffffff">

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />

    <link rel="stylesheet" href="style.css" />
    <!-- Supabase Core & Configuration -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="auth-guard.js"></script>

    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        .app-container {
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .main-header {
            padding: var(--spacing-md) var(--spacing-xl);
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .page-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }

        .conversations-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: var(--bg-card);
        }

        #chatwoot-iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-card);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.3s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(139, 92, 246, 0.1);
            border-top-color: var(--accent-purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: var(--spacing-lg);
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            color: var(--text-gray);
            font-size: 14px;
        }

        .error-message {
            color: #ff4444;
            background: rgba(255, 68, 68, 0.1);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            margin-top: var(--spacing-md);
            max-width: 400px;
            text-align: center;
        }
    </style>
</head>

<body>
    <div class="layout-wrapper">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="logo.png" alt="Logo" class="sidebar-logo" />
                <button class="toggle-btn" id="toggleSidebar">
                    <i class="ph ph-list"></i>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="crm.html" class="nav-link">
                    <i class="ph-fill ph-users-three"></i>
                    <span class="link-text">CRM</span>
                </a>
                <a href="conversas.html" class="nav-link active">
                    <i class="ph-fill ph-chat-circle-dots"></i>
                    <span class="link-text">Conversas</span>
                </a>
                <a href="index.html" class="nav-link">
                    <i class="ph-fill ph-shopping-cart"></i>
                    <span class="link-text">Pedidos</span>
                </a>
                <a href="ranking-produtos.html" class="nav-link">
                    <i class="ph-fill ph-trophy"></i>
                    <span class="link-text">Ranking de Produtos</span>
                </a>
                <a href="carrinhos-abandonados.html" class="nav-link">
                    <i class="ph-fill ph-shopping-cart-simple"></i>
                    <span class="link-text">Carrinhos Abandonados</span>
                </a>
                <a href="estoque.html" class="nav-link">
                    <i class="ph-fill ph-package"></i>
                    <span class="link-text">Estoque</span>
                </a>
                <a href="calculadora-custos.html" class="nav-link">
                    <i class="ph-fill ph-calculator"></i>
                    <span class="link-text">Calculadora de Custos</span>
                </a>
            </nav>

            <div class="sidebar-footer">
                <a href="#" id="logout-btn" class="nav-link" style="color: #ff4d4d; margin-top: auto;">
                    <i class="ph-fill ph-sign-out"></i>
                    <span class="link-text">Sair da Conta</span>
                </a>
            </div>
        </aside>

        <div class="main-content">
            <div class="app-container">
                <header class="main-header">
                    <h1 class="page-title">
                        <i class="ph-fill ph-chat-circle-dots"></i>
                        Central de Atendimento Omnichannel
                    </h1>
                </header>

                <div class="conversations-container">
                    <iframe id="chatwoot-iframe" allow="camera;microphone;clipboard-read;clipboard-write"
                        sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-modals">
                    </iframe>

                    <div id="loading-overlay" class="loading-overlay">
                        <div class="spinner"></div>
                        <p class="loading-text" id="loading-text">Conectando ao Chatwoot...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>

    <script>
        (function () {
            'use strict';

            const iframe = document.getElementById('chatwoot-iframe');
            const overlay = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');

            async function initChatwoot() {
                try {
                    console.log('üöÄ Iniciando integra√ß√£o com Chatwoot...');
                    loadingText.textContent = 'Autenticando...';

                    // Busca a URL de SSO
                    const response = await fetch('/api/chatwoot/sso', {
                        method: 'GET',
                        credentials: 'include',
                        headers: { 'Accept': 'application/json' }
                    });

                    if (!response.ok) {
                        throw new Error(`Erro HTTP: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('‚úÖ SSO URL recebida:', data.ssoUrl);

                    if (!data.success || !data.ssoUrl) {
                        throw new Error('URL de SSO inv√°lida');
                    }

                    loadingText.textContent = 'Carregando interface...';

                    // O proxy agora est√° na raiz (/), ent√£o removemos o dom√≠nio original da URL de SSO
                    // para que a requisi√ß√£o passe pelo nosso servidor Express (mesma origem)
                    const urlObj = new URL(data.ssoUrl);
                    const localSsoUrl = urlObj.pathname + urlObj.search;

                    console.log('üîó URL Local do SSO:', localSsoUrl);

                    // Define a URL no iframe
                    iframe.src = localSsoUrl;

                    // Esconde o loading ap√≥s carregar
                    iframe.onload = () => {
                        overlay.classList.add('hidden');
                        console.log('‚úÖ Chatwoot carregado com sucesso!');
                    };

                    // Fallback para esconder o loading caso o iframe.onload demore muito
                    setTimeout(() => {
                        overlay.classList.add('hidden');
                    }, 5000);

                } catch (error) {
                    console.error('‚ùå Erro ao carregar Chatwoot:', error);
                    loadingText.innerHTML = `
                        <div class="error-message">
                            <strong>Erro ao conectar</strong><br>
                            ${error.message}
                        </div>
                    `;
                }
            }

            // Inicia quando a p√°gina carregar
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initChatwoot);
            } else {
                initChatwoot();
            }
        })();
    </script>
</body>

</html>